<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Oberheim DMX</title>
<link href='https://fonts.googleapis.com/css?family=Arvo:700' rel='stylesheet' type='text/css'>
<style>
@font-face {
  font-family: 'Handel Gothic';
  src: url('assets/fonts/handel-gothic.TTF');
}

@font-face {
  font-family: 'Friz Quadrata Bold';
  src: url('assets/fonts/FrizQuadrataBold.ttf');
}

body {
    text-align: center;
    white-space: nowrap;
    margin: 0px;
    font-family: 'Handel Gothic';
    font-size: 10px;
}

canvas{
  border: 0;
  padding: 0;
  margin: 0;
}
.onediv {
    display: inline-block;
    height: 800px;
    width: 20px;
    background-color:brown;
    margin: 0px;
    padding: 0px;
}
.twodiv {
    display: inline-block;
    height: 800px;
    width: 1200px;
    color: white;
    margin: 0px;
    padding: 0px;
}

.twodiv .power {
    background-color: #3d3c42;
    width: 100%;
    height: 30%;

    margin: 0px;
    padding: 0px;
}

.twodiv .power div {
    position:absolute;
    font-family: 'Friz Quadrata Bold';
    font-size: 72px;
    top:0px;
    width: 1200px;
    height: 100%;
    margin: 0px;
    padding: 0px;
}

.twodiv .power div hr {
    width: 100%;
    background-color:#6eccff;
    height:3px;
    border: 0px;
    margin-top: 0px;
    margin-bottom: 5px;
}

.twodiv .faders {
    background-color: #2e2d32;
    width: 100%;
    height: 70%;

    margin: 0px;
    padding: 0px;
}

.twodiv .faders .lines {
    display: inline-block;
    height: 100%;
    width: 720px;

    margin: 0px;
    padding: 0px;
}

.twodiv .faders .lines .line {
    position: relative;
    display: inline-block;
    height: 100%;
    width: 90px;
}

.twodiv .faders .lines .line div {
    position:absolute;
    top:0px;
    display: block;
    height: 100%;
    width: 100%;
    font-family: 'Handel Gothic';

}

.twodiv .faders .lines .line div .fader {
    position:relative;
    display: block;
    margin-top: 40px;
    margin-left: auto;
    margin-right: auto;
    height: 200px;
    width: 60px;
}

.twodiv .faders .lines .line div .fader input[type=range][orient=vertical]
{
    writing-mode: bt-lr; /* IE */
    -webkit-appearance: slider-vertical; /* WebKit */
    width: 8px;
    height: 175px;
    padding: 0 5px;
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.twodiv .faders .lines .line div .pushbutton {
    position:relative;
    margin-left: auto;
    margin-right: auto;
    background-color: #000;
    display: block;
    height: 60px;
    width: 60px;
}

.twodiv .faders .control {
    display: inline-block;
    height: 100%;
    width: 480px;
    margin: 0px;
    padding: 0px;
}

.twodiv .faders .control .beatcontrol {
    position: relative;
    display: inline-block;
    height: 100%;
    width: 192px;
}

.twodiv .faders .control .beatcontrol div {
    position:absolute;
    top:0px;
    display: block;
    height: 100%;
    width: 100%;
}

.twodiv .faders .control .beatcontrol div .fader {
    position:relative;
    display: block;
    margin-top: 40px;
    margin-left: auto;
    margin-right: auto;
    height: 200px;
}

.twodiv .faders .control .beatcontrol div .fader .metronome {
    position:relative;
    display: inline-block;
    height: 200px;
    width: 96px;
}

.twodiv .faders .control .beatcontrol div .fader .volume {
    position:relative;
    display: inline-block;
    height: 200px;
    width: 96px;
}

.twodiv .faders .control .beatcontrol div .fader .metronome input[type=range][orient=vertical]
{
    writing-mode: bt-lr; /* IE */
    -webkit-appearance: slider-vertical; /* WebKit */
    width: 8px;
    height: 175px;
    padding: 0 5px;
    display: inline-block;
    margin-left: auto;
    margin-right: auto;
}

.twodiv .faders .control .beatcontrol div .fader .volume input[type=range][orient=vertical]
{
    writing-mode: bt-lr; /* IE */
    -webkit-appearance: slider-vertical; /* WebKit */
    width: 8px;
    height: 175px;
    padding: 0 5px;
    display: inline-block;
    margin-left: auto;
    margin-right: auto;
}

.twodiv .faders .control .beatcontrol div .pushbutton {
    position:relative;
    margin-left: auto;
    margin-right: auto;
    background-color: #000;
    display: inline-block;
    height: 60px;
    width: 60px;
}

.twodiv .faders .control .trackcontrol {
    position: relative;
    display: inline-block;
    height: 100%;
    width: 288px;
}

.twodiv .faders .control .trackcontrol div {
    position:absolute;
    top:0px;
    display: block;
    height: 100%;
    width: 100%;
}

.twodiv .faders .control .trackcontrol div .textbtn {
    position:relative;
/*    font-family: 'Handel Gothic';*/
    margin-left: auto;
    margin-right: auto;
/*    background-color: #000;*/
    display: inline-block;
    height: 10px;
    width: 60px;
}

.twodiv .faders .control .trackcontrol div .pushbutton {
    position:relative;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    vertical-align: middle;
    line-height: 60px;
    background-color: #000;
    display: inline-block;
    height: 60px;
    width: 60px;
}

.twodiv .faders .control .trackcontrol div .display {
    position:relative;
    margin-left: auto;
    margin-right: auto;
    background-color: #888;
    display: block;
    height: 60px;
    width: 240px;
}

.playbtn {
  background-color: #f6faf9 !important;
}

.recordbtn {
  background-color: #fe4c58 !important;
}

.numbers{
  font-family: 'Arvo', serif !important;
  font-size: 18px;
}

.btn {
  display: inline-block;
  width: 20px;
  height: 20px;
  color: #FCFBE7;
  font-size: 2em;
  text-align: center;
  text-decoration: none;
  positon: relative;
  text-transform: capitalize;
  margin-top: 10px;
  /*  border-radius: 10px;*/
}

.red {
  background-color: #851A29;
  border-right: 20px solid #C4273C;
  text-shadow: 1px 2px rgba(133, 26, 41, .8);
}

.red:hover {
  /* margin-top: 2px;*/
  /*border-bottom: 2px solid #851A29;*/
}

.btn:active {
  background-color: #C4273C;
  border-right: 20px solid #851A29;
  text-shadow: 1px 2px rgba(133, 26, 41, .8);
}
</style>
</head>

<body>
<div class = "onediv"></div><div class = "twodiv"><div class = "power"><div><a class="btn red" href="#"></a><hr><hr>DMX</div></div><div class = "faders"><div class = "lines">
      <div class="line">
        <div>
          <div class="fader">
          <input type="range" orient="vertical" />
          </div>
          BASS<br/><br/>
            <div class="pushbutton"></div>
            1
            <div class="pushbutton"></div>
            2
            <div class="pushbutton"></div>
            3
        </div>
      </div><div class="line">
        <div>
          <div class="fader">
          <input type="range" orient="vertical" />
          </div>
          SNARE<br/><br/>
          <div class="pushbutton"></div>
          1
          <div class="pushbutton"></div>
          2
          <div class="pushbutton"></div>
          3
      </div>
    </div><div class="line">
        <div>
          <div class="fader">
            <input type="range" orient="vertical" />
          </div>
          HI-HAT<br/><br/>
          <div class="pushbutton"></div>
          CLOSED
          <div class="pushbutton"></div>
          ACCENT
          <div class="pushbutton"></div>
          OPEN
      </div></div><div class="line">
        <div>
          <div class="fader">
          <input type="range" orient="vertical" />
          </div>
          --TOMS--<br/><br/>
          <div class="pushbutton"></div>
          1
          <div class="pushbutton"></div>
          2
          <div class="pushbutton"></div>
          3
      </div></div><div class="line">
        <div>
          <div class="fader">
          <input type="range" orient="vertical" />
          </div>
          --TOMS--<br/><br/>
          <div class="pushbutton"></div>
          4
          <div class="pushbutton"></div>
          5
          <div class="pushbutton"></div>
          6
      </div></div><div class="line">
        <div>
          <div class="fader">
          <input type="range" orient="vertical" />
          </div>
          CYMBAL<br/><br/>
          <div class="pushbutton"></div>
          RIDE 1
          <div class="pushbutton"></div>
          RIDE 2
          <div class="pushbutton"></div>
          CRASH
      </div></div><div class="line">
        <div>
          <div class="fader">
          <input type="range" orient="vertical" />
          </div>
          PERC 1<br/><br/>
          <div class="pushbutton"></div>
          TAMB 1
          <div class="pushbutton"></div>
          TAMB 2
          <div class="pushbutton"></div>
          RIMSHOT
      </div></div><div class="line">
        <div>
          <div class="fader">
          <input type="range" orient="vertical" />
          </div>
          PERC 2<br/><br/>
          <div class="pushbutton"></div>
          SHAKER 1
          <div class="pushbutton"></div>
          SHAKER 2
          <div class="pushbutton"></div>
          CLAPS
      </div></div>
    </div><div class = "control">
    <div class="beatcontrol"><div>
      <div class="fader">
        <div class="metronome">
          <input type="range" orient="vertical" />
        </div>
        <div class="volume">
          <input type="range" orient="vertical" />
        </div>
      </div>METRONOME / VOLUME<br/><br/>
                                  <div class="pushbutton"></div><div class="pushbutton"></div><div class="pushbutton"></div>
                                  <br/><br/>
                                  <div class="pushbutton playbtn"></div><br/>
                                  PLAY/STOP
                                </div></div><div class="trackcontrol"><div><br/><div class="display"><div>

<svg class="seven-segment"
     width="10" height="50"
     viewBox="0 0 22 36" preserveAspectRatio="xMidYMid">
  <g stroke="#000" fill="#000" stroke-width="0.2">
    <polygon class="A" points=" 5, 4  7, 6 15, 6 17, 4 15, 2  7, 2">
      <animate attributeName="opacity" begin="0s" dur="5s" repeatCount="15"
               calcMode="discrete" fill="freeze"
               values="1;0;1;1;0;1;1;1;1;1;"/>
    </polygon>

    <polygon class="B" points="18, 5 16, 7 16,15 18,17 20,15 20, 7">
      <animate attributeName="opacity" begin="0s" dur="5s" repeatCount="15"
               calcMode="discrete" fill="freeze"
               values="1;1;1;1;1;0;0;1;1;1;"/>
    </polygon>

    <polygon class="C" points="18,19 16,21 16,29 18,31 20,29 20,21">
      <animate attributeName="opacity" begin="0s" dur="5s" repeatCount="15"
               calcMode="discrete" fill="freeze"
               values="1;1;0;1;1;1;1;1;1;1;" />
    </polygon>

    <polygon class="D" points=" 5,32  7,34 15,34 17,32 15,30  7,30">
      <animate attributeName="opacity" begin="0s" dur="5s" repeatCount="15"
               calcMode="discrete" fill="freeze"
               values="1;0;1;1;0;1;1;0;1;1;" />
    </polygon>

    <polygon class="E" points=" 4,19  2,21  2,29  4,31  6,29  6,21">
      <animate attributeName="opacity" begin="0s" dur="5s" repeatCount="15"
               calcMode="discrete"
               fill="freeze"
               values="1;0;1;0;0;0;1;0;1;0;" />
    </polygon>

    <polygon class="F" points=" 4, 5  2, 7  2,15  4,17  6,15  6, 7">
      <animate attributeName="opacity" begin="0s" dur="5s" repeatCount="15"
               calcMode="discrete" fill="freeze"
               values="1;0;0;0;1;1;1;0;1;1;" />
    </polygon>

    <polygon class="G" points=" 5,18  7,20 15,20 17,18 15,16  7,16">
      <animate attributeName="opacity" begin="0s" dur="5s" repeatCount="15"
               calcMode="discrete" fill="freeze"
               values="0;0;1;1;1;1;1;0;1;1;" />
    </polygon>
  </g>
</svg>
</div>
</div>
                                  <br/><br/>
                                                                <div class="pushbutton numbers">7</div><div class="pushbutton numbers">8</div><div class="pushbutton numbers">9</div><br/>
                                                                <div class="pushbutton numbers">4</div><div class="pushbutton numbers">5</div><div class="pushbutton numbers">6</div><br/>
                                                                <div class="pushbutton numbers">1</div><div class="pushbutton numbers">2</div><div class="pushbutton numbers">3</div><br/>
                                                                <div class="pushbutton numbers"><</div><div class="pushbutton numbers">0</div><div class="pushbutton numbers">></div><br/>
                                                                <br/><br/>
                                                                <div class="textbtn"></div><div class="textbtn">CHECK</div><div class="textbtn">PLAY</div><div class="textbtn">RECORD</div><br/>
                                                                <div class="pushbutton"></div><div class="pushbutton"></div><div class="pushbutton"></div><div class="pushbutton"></div><br/>
                                                                <div class="textbtn">SWING</div><div class="textbtn">SONG</div><div class="textbtn">EDIT</div><div class="textbtn">STEP</div><br/>
                                                                <div class="pushbutton recordbtn"></div><div class="pushbutton"></div><div class="pushbutton"></div><div class="pushbutton"></div><br/>
                                                                <div class="textbtn">RECORD</div><div class="textbtn">ERASE</div><div class="textbtn">COPY</div><div class="textbtn">LENGTH</div><br/>

                                </div></div>
  </div>
  </div>
</div><div class = "onediv"></div>
<script src="http://cwilso.github.io/AudioContext-MonkeyPatch/AudioContextMonkeyPatch.js"></script>
<script type="text/javascript">

window.onload = init;

var context;
var convolver;
var compressor;
var masterGainNode;
var effectLevelNode;
var filterNode;

// Each effect impulse response has a specific overall desired dry and wet volume.
// For example in the telephone filter, it's necessary to make the dry volume 0 to correctly hear the effect.
var effectDryMix = 1.0;
var effectWetMix = 1.0;

var timeoutId;

var startTime;
var lastDrawTime = -1;

var kits;

var kNumInstruments = 6;
var kInitialKitIndex = 0;
var kMaxSwing = .08;

var currentKit;

var beatReset = {"kitIndex":0,"effectIndex":0,"tempo":100,"swingFactor":0,"effectMix":0.25,"kickPitchVal":0.5,"snarePitchVal":0.5,"hihatPitchVal":0.5,"tom1PitchVal":0.5,"tom2PitchVal":0.5,"tom3PitchVal":0.5,"rhythm1":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"rhythm2":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"rhythm3":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"rhythm4":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"rhythm5":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"rhythm6":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};
var beatDemo = [
    {"kitIndex":0,"effectIndex":0,"tempo":120,"swingFactor":0,"effectMix":0.19718309859154926,"kickPitchVal":0.5,"snarePitchVal":0.5,"hihatPitchVal":0.5,"tom1PitchVal":0.5,"tom2PitchVal":0.5,"tom3PitchVal":0.5,"rhythm1":[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"rhythm2":[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],"rhythm3":[0,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0],"rhythm4":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0],"rhythm5":[0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0],"rhythm6":[0,0,0,0,0,0,0,2,0,2,2,0,0,0,0,0]}
];

var keys = new Array( 256 );
keys[65] = 60; // = C4 ("middle C")
keys[87] = 61;
keys[83] = 62;
keys[69] = 63;
keys[68] = 64; // KB-D
keys[70] = 65; // = F4
keys[84] = 66;
keys[71] = 67;
keys[89] = 68;
keys[72] = 69;
keys[85] = 70;
keys[74] = 71;
keys[75] = 72; // = C5
keys[79] = 73;
keys[76] = 74;
keys[80] = 75;
keys[186] = 76;
keys[222] = 77; // = F5
keys[221] = 78;
keys[13] = 79;
keys[220] = 80;

function cloneBeat(source) {
    var beat = new Object();

    beat.kitIndex = source.kitIndex;
    beat.effectIndex = source.effectIndex;
    beat.tempo = source.tempo;
    beat.swingFactor = source.swingFactor;
    beat.effectMix = source.effectMix;
    beat.kickPitchVal = source.kickPitchVal;
    beat.snarePitchVal = source.snarePitchVal;
    beat.hihatPitchVal = source.hihatPitchVal;
    beat.tom1PitchVal = source.tom1PitchVal;
    beat.tom2PitchVal = source.tom2PitchVal;
    beat.tom3PitchVal = source.tom3PitchVal;
    beat.rhythm1 = source.rhythm1.slice(0);        // slice(0) is an easy way to copy the full array
    beat.rhythm2 = source.rhythm2.slice(0);
    beat.rhythm3 = source.rhythm3.slice(0);
    beat.rhythm4 = source.rhythm4.slice(0);
    beat.rhythm5 = source.rhythm5.slice(0);
    beat.rhythm6 = source.rhythm6.slice(0);

    return beat;
}


var theBeat = cloneBeat(beatReset);

kickPitch = snarePitch = hihatPitch = tom1Pitch = tom2Pitch = tom3Pitch = 0;

var mouseCapture = null;
var mouseCaptureOffset = 0;

var loopLength = 16;
var rhythmIndex = 0;
var kMinTempo = 53;
var kMaxTempo = 180;
var noteTime = 0.0;

var instruments = ['Kick', 'Snare', 'HiHat', 'Tom1', 'Tom2', 'Tom3'];

var volumes = [0, 0.3, 1];

var kitCount = 0;

var kitName = 'DMX';

var kitNamePretty = 'Oberheim DMX';

function Kit(name) {
    this.name = name;

    this.pathName = function() {
//        var pathName = "assets/sounds/" + this.name + "/";
        var pathName = "assets/sounds/";
        return pathName;
    };

    this.kickBuffer = 0;
    this.snareBuffer = 0;
    this.hihatBuffer = 0;

    this.instrumentCount = kNumInstruments;
    this.instrumentLoadCount = 0;

    this.startedLoading = false;
    this.isLoaded = false;

    this.demoIndex = -1;
}

Kit.prototype.setDemoIndex = function(index) {
    this.demoIndex = index;
}

Kit.prototype.load = function() {
    if (this.startedLoading)
        return;

    this.startedLoading = true;

    var pathName = this.pathName();

    var kick1Path = pathName + "03_BASS_01.wav";
    var kick2Path = pathName + "04_BASS_02.wav";
    var kick3Path = pathName + "05_BASS_03.wav";
    var snarePath = pathName + "06_SNARE_01.wav";
    var hihatPath = pathName + "09_HI-HAT_CLOSED.wav";
    var tom1Path = pathName + "12_TOM_01.wav";
    var tom2Path = pathName + "13_TOM_02.wav";
    var tom3Path = pathName + "14_TOM_03.wav";

    this.loadSample(0, kick1Path, false);
    this.loadSample(1, kick2Path, false);
    this.loadSample(2, kick3Path, false);
    this.loadSample(3, snarePath, false);
    this.loadSample(4, hihatPath, true);  // we're panning only the hihat
    this.loadSample(5, tom1Path, false);
    this.loadSample(6, tom2Path, false);
    this.loadSample(7, tom3Path, false);
}

var decodedFunctions = [
function (buffer) { this.kick1Buffer = buffer; },
function (buffer) { this.kick2Buffer = buffer; },
function (buffer) { this.kick3Buffer = buffer; },
function (buffer) { this.snareBuffer = buffer; },
function (buffer) { this.hihatBuffer = buffer; },
function (buffer) { this.tom1 = buffer; },
function (buffer) { this.tom2 = buffer; },
function (buffer) { this.tom3 = buffer; } ];

Kit.prototype.loadSample = function(sampleID, url, mixToMono) {
    // Load asynchronously

    var request = new XMLHttpRequest();
    request.open("GET", url, true);
    request.responseType = "arraybuffer";

    var kit = this;

    request.onload = function() {
        context.decodeAudioData(request.response, decodedFunctions[sampleID].bind(kit));

        kit.instrumentLoadCount++;
        if (kit.instrumentLoadCount == kit.instrumentCount) {
            kit.isLoaded = true;

            //if (kit.demoIndex != -1) {
            //    beatDemo[kit.demoIndex].setKitLoaded();
            //}
        }
    }

    request.send();
}

function startLoadingAssets() {

//    var numKits = kitName.length;
    var numKits = 1;
    kits = new Array(numKits);
  //  for (var i  = 0; i < numKits; i++) {
//        kits[i] = new Kit(kitName[i]);
  //  }
    kits[0] = new Kit(kitName);

    for (var i  = 0; i < numKits; i++) {
        kits[i].load();
    }

    currentKit = kits[kInitialKitIndex];
}

function keyDown( ev ) {

	if ((ev.keyCode==49)||(ev.keyCode==50)) {
		if (ev.keyCode==49)
			moDouble = true;
		else if (ev.keyCode==50)
			moQuadruple = true;
		changeModMultiplier();
	}

	var note = keys[ev.keyCode];
	if (note)
    console.log( "key down: " + ev.keyCode + note );
    if (note == 60) // A
    {playNote(currentKit.kick1Buffer,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}
    if (note == 61) // W
    {playNote(currentKit.kick2Buffer,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}
    if (note == 62) // S
    {playNote(currentKit.kick3Buffer,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}

    if (note == 64) // D
    {playNote(currentKit.snareBuffer,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}

    if (note == 67) // G
    {playNote(currentKit.hihatBuffer,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}

    if (note == 71) // J
    {playNote(currentKit.tom1,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}
    if (note == 72) // K
    {playNote(currentKit.tom2,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}
    if (note == 74) // L
    {playNote(currentKit.tom3,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}

	return false;
}

function keyUp( ev ) {
	if ((ev.keyCode==49)||(ev.keyCode==50)) {
		if (ev.keyCode==49)
			moDouble = false;
		else if (ev.keyCode==50)
			moQuadruple = false;
		changeModMultiplier();
	}

	var note = keys[ev.keyCode];
	if (note)
    console.log( "key up: " + ev.keyCode + note );
		//noteOff( note + 12*(3-currentOctave) );
    //if (note = 64)
    //{playNote(currentKit.snareBuffer,  false, 0,0,-2,  0.5, 1, kickPitch,  0);}
	//console.log( "key up: " + ev.keyCode );

	return false;
}

function init() {
  window.addEventListener('keydown', keyDown, false);
  window.addEventListener('keyup', keyUp, false);

    startLoadingAssets();

    // NOTE: THIS NOW RELIES ON THE MONKEYPATCH LIBRARY TO LOAD
    // IN CHROME AND SAFARI (until they release unprefixed)
    context = new AudioContext();
    console.log(context);

    var finalMixNode;
    if (context.createDynamicsCompressor) {
        // Create a dynamics compressor to sweeten the overall mix.
        compressor = context.createDynamicsCompressor();
        compressor.connect(context.destination);
        finalMixNode = compressor;
    } else {
        // No compressor available in this implementation.
        finalMixNode = context.destination;
    }

    // create master filter node
    filterNode = context.createBiquadFilter();
    filterNode.type = "lowpass";
    filterNode.frequency.value = 0.5 * context.sampleRate;
    filterNode.Q.value = 1;
    filterNode.connect(finalMixNode);

    // Create master volume.
    masterGainNode = context.createGain();
    masterGainNode.gain.value = 0.7; // reduce overall volume to avoid clipping
    masterGainNode.connect(filterNode);

    // Create effect volume.
    effectLevelNode = context.createGain();
    effectLevelNode.gain.value = 1.0; // effect level slider controls this
    effectLevelNode.connect(masterGainNode);

    // Create convolver for effect
    convolver = context.createConvolver();
    convolver.connect(effectLevelNode);
}

function advanceNote() {
    // Advance time by a 16th note...
    var secondsPerBeat = 60.0 / theBeat.tempo;

    rhythmIndex++;
    if (rhythmIndex == loopLength) {
        rhythmIndex = 0;
    }

        // apply swing
    if (rhythmIndex % 2) {
        noteTime += (0.25 + kMaxSwing * theBeat.swingFactor) * secondsPerBeat;
    } else {
        noteTime += (0.25 - kMaxSwing * theBeat.swingFactor) * secondsPerBeat;
    }
}

function playNote(buffer, pan, x, y, z, sendGain, mainGain, playbackRate, noteTime) {
    // Create the note
    var voice = context.createBufferSource();
    voice.buffer = buffer;
  //  console.log(buffer, playbackRate);
  //  voice.playbackRate.value = playbackRate;

    // Optionally, connect to a panner
    var finalNode;
    if (pan) {
        var panner = context.createPanner();
        panner.panningModel = "HRTF";
        panner.setPosition(x, y, z);
        voice.connect(panner);
        finalNode = panner;
    } else {
        finalNode = voice;
    }

    // Connect to dry mix
    var dryGainNode = context.createGain();
    dryGainNode.gain.value = mainGain * effectDryMix;
    finalNode.connect(dryGainNode);
    dryGainNode.connect(masterGainNode);

    // Connect to wet mix
    var wetGainNode = context.createGain();
   wetGainNode.gain.value = sendGain;
   finalNode.connect(wetGainNode);
    wetGainNode.connect(convolver);

    voice.start(noteTime);
}

function schedule() {
    var currentTime = context.currentTime;

    // The sequence starts at startTime, so normalize currentTime so that it's 0 at the start of the sequence.
    currentTime -= startTime;

    while (noteTime < currentTime + 0.120) {
        // Convert noteTime to context time.
        var contextPlayTime = noteTime + startTime;

        // Kick
        if (theBeat.rhythm1[rhythmIndex] && instrumentActive[0]) {
            playNote(currentKit.kickBuffer, false, 0,0,-2, 0.5, volumes[theBeat.rhythm1[rhythmIndex]] * 1.0, kickPitch, contextPlayTime);
        }

        // Snare
        if (theBeat.rhythm2[rhythmIndex] && instrumentActive[1]) {
            playNote(currentKit.snareBuffer, false, 0,0,-2, 1, volumes[theBeat.rhythm2[rhythmIndex]] * 0.6, snarePitch, contextPlayTime);
        }

        // Hihat
        if (theBeat.rhythm3[rhythmIndex] && instrumentActive[2]) {
            // Pan the hihat according to sequence position.
            playNote(currentKit.hihatBuffer, true, 0.5*rhythmIndex - 4, 0, -1.0, 1, volumes[theBeat.rhythm3[rhythmIndex]] * 0.7, hihatPitch, contextPlayTime);
        }

        // Toms
        if (theBeat.rhythm4[rhythmIndex] && instrumentActive[3]) {
            playNote(currentKit.tom1, false, 0,0,-2, 1, volumes[theBeat.rhythm4[rhythmIndex]] * 0.6, tom1Pitch, contextPlayTime);
        }

        if (theBeat.rhythm5[rhythmIndex] && instrumentActive[4]) {
            playNote(currentKit.tom2, false, 0,0,-2, 1, volumes[theBeat.rhythm5[rhythmIndex]] * 0.6, tom2Pitch, contextPlayTime);
        }

        if (theBeat.rhythm6[rhythmIndex] && instrumentActive[5]) {
            playNote(currentKit.tom3, false, 0,0,-2, 1, volumes[theBeat.rhythm6[rhythmIndex]] * 0.6, tom3Pitch, contextPlayTime);
        }


        // Attempt to synchronize drawing time with sound
        if (noteTime != lastDrawTime) {
            lastDrawTime = noteTime;
            drawPlayhead((rhythmIndex + 15) % 16);
        }

        advanceNote();
    }
}

function playDrum(noteNumber, velocity) {
    switch (noteNumber) {
        case 0x24:
            playNote(currentKit.kickBuffer,  false, 0,0,-2,  0.5, (velocity / 127), kickPitch,  0);
            break;
        case 0x26:
            playNote(currentKit.snareBuffer, false, 0,0,-2,  1,   (velocity / 127), snarePitch, 0);
            break;
        case 0x28:
            playNote(currentKit.hihatBuffer, true,  0,0,-1.0,1,   (velocity / 127), hihatPitch, 0);
            break;
        case 0x2d:
            playNote(currentKit.tom1,        false, 0,0,-2,  1,   (velocity / 127), tom1Pitch,  0);
            break;
        case 0x2f:
            playNote(currentKit.tom2,        false, 0,0,-2,  1,   (velocity / 127), tom2Pitch,  0);
            break;
        case 0x32:
            playNote(currentKit.tom3,        false, 0,0,-2,  1,   (velocity / 127), tom3Pitch,  0);
            break;
        default:
            console.log("note:0x" + noteNumber.toString(16) );
    }
}


function tempoIncrease() {
    theBeat.tempo = Math.min(kMaxTempo, theBeat.tempo+4);
    document.getElementById('tempo').innerHTML = theBeat.tempo;
}

function tempoDecrease() {
    theBeat.tempo = Math.max(kMinTempo, theBeat.tempo-4);
    document.getElementById('tempo').innerHTML = theBeat.tempo;
}

function sliderSetValue(slider, value) {
    var pitchRate = Math.pow(2.0, 2.0 * (value - 0.5));

    switch(slider) {
    case 'effect_thumb':
        // Change the volume of the convolution effect.
        theBeat.effectMix = value;
        setEffectLevel(theBeat);
        break;
    case 'kick_thumb':
        theBeat.kickPitchVal = value;
        kickPitch = pitchRate;
        break;
    case 'snare_thumb':
        theBeat.snarePitchVal = value;
        snarePitch = pitchRate;
        break;
    case 'hihat_thumb':
        theBeat.hihatPitchVal = value;
        hihatPitch = pitchRate;
        break;
    case 'tom1_thumb':
        theBeat.tom1PitchVal = value;
        tom1Pitch = pitchRate;
        break;
    case 'tom2_thumb':
        theBeat.tom2PitchVal = value;
        tom2Pitch = pitchRate;
        break;
    case 'tom3_thumb':
        theBeat.tom3PitchVal = value;
        tom3Pitch = pitchRate;
        break;
    case 'swing_thumb':
        theBeat.swingFactor = value;
        break;
    }
}

function sliderSetPosition(slider, value) {
    var elThumb = document.getElementById(slider);
    var elTrack = elThumb.parentNode;

    if (slider == 'swing_thumb') {
        var thumbW = elThumb.clientWidth;
        var trackW = elTrack.clientWidth;
        var travelW = trackW - thumbW;

        elThumb.style.left = travelW * value + 'px';
    } else {
        var thumbH = elThumb.clientHeight;
        var trackH = elTrack.clientHeight;
        var travelH = trackH - thumbH;

        elThumb.style.top = travelH * (1.0 - value) + 'px';
    }
}

function handleButtonMouseDown(event) {
    var notes = theBeat.rhythm1;

    var instrumentIndex;
    var rhythmIndex;

    var elId = event.target.id;
    rhythmIndex = elId.substr(elId.indexOf('_') + 1, 2);
    instrumentIndex = instruments.indexOf(elId.substr(0, elId.indexOf('_')));

    switch (instrumentIndex) {
        case 0: notes = theBeat.rhythm1; break;
        case 1: notes = theBeat.rhythm2; break;
        case 2: notes = theBeat.rhythm3; break;
        case 3: notes = theBeat.rhythm4; break;
        case 4: notes = theBeat.rhythm5; break;
        case 5: notes = theBeat.rhythm6; break;
    }

    notes[rhythmIndex] = (notes[rhythmIndex] + 1) % 3;

    if (instrumentIndex == currentlyActiveInstrument)
        showCorrectNote( rhythmIndex, notes[rhythmIndex] );

    drawNote(notes[rhythmIndex], rhythmIndex, instrumentIndex);

    var note = notes[rhythmIndex];

    if (note) {
        switch(instrumentIndex) {
        case 0:  // Kick
          playNote(currentKit.kickBuffer, false, 0,0,-2, 0.5 * theBeat.effectMix, volumes[note] * 1.0, kickPitch, 0);
          break;

        case 1:  // Snare
          playNote(currentKit.snareBuffer, false, 0,0,-2, theBeat.effectMix, volumes[note] * 0.6, snarePitch, 0);
          break;

        case 2:  // Hihat
          // Pan the hihat according to sequence position.
          playNote(currentKit.hihatBuffer, true, 0.5*rhythmIndex - 4, 0, -1.0, theBeat.effectMix, volumes[note] * 0.7, hihatPitch, 0);
          break;

        case 3:  // Tom 1
          playNote(currentKit.tom1, false, 0,0,-2, theBeat.effectMix, volumes[note] * 0.6, tom1Pitch, 0);
          break;

        case 4:  // Tom 2
          playNote(currentKit.tom2, false, 0,0,-2, theBeat.effectMix, volumes[note] * 0.6, tom2Pitch, 0);
          break;

        case 5:  // Tom 3
          playNote(currentKit.tom3, false, 0,0,-2, theBeat.effectMix, volumes[note] * 0.6, tom3Pitch, 0);
          break;
        }
    }
}


function isDescendantOfId(el, id) {
    if (el.parentElement) {
        if (el.parentElement.id == id) {
            return true;
        } else {
            return isDescendantOfId(el.parentElement, id);
        }
    } else {
        return false;
    }
}

function handleEffectComboMouseDown(event) {
    if (event.target.id != 'effectlist') {
        document.getElementById('effectcombo').classList.toggle('active');
    }
}

function handleEffectMouseDown(event) {
    for (var i = 0; i < impulseResponseInfoList.length; ++i) {
        if (impulseResponseInfoList[i].name == event.target.innerHTML) {

            // Hack - if effect is turned all the way down - turn up effect slider.
            // ... since they just explicitly chose an effect from the list.
            if (theBeat.effectMix == 0)
                theBeat.effectMix = 0.5;

            setEffect(i);
            break;
        }
    }
}

function setEffect(index) {
    if (index > 0 && !impulseResponseList[index].isLoaded()) {
        alert('Sorry, this effect is still loading.  Try again in a few seconds :)');
        return;
    }

    theBeat.effectIndex = index;
    effectDryMix = impulseResponseInfoList[index].dryMix;
    effectWetMix = impulseResponseInfoList[index].wetMix;
    convolver.buffer = impulseResponseList[index].buffer;

  // Hack - if the effect is meant to be entirely wet (not unprocessed signal)
  // then put the effect level all the way up.
    if (effectDryMix == 0)
        theBeat.effectMix = 1;

    setEffectLevel(theBeat);
    sliderSetValue('effect_thumb', theBeat.effectMix);
    updateControls();

  //  document.getElementById('effectname').innerHTML = impulseResponseInfoList[index].name;
}

function setEffectLevel() {
    // Factor in both the preset's effect level and the blending level (effectWetMix) stored in the effect itself.
    effectLevelNode.gain.value = theBeat.effectMix * effectWetMix;
}



function handlePlay(event) {
    noteTime = 0.0;
    startTime = context.currentTime + 0.005;
    schedule();
    timerWorker.postMessage("start");

    document.getElementById('play').classList.add('playing');
    document.getElementById('stop').classList.add('playing');
    if (midiOut) {
        // turn off the play button
        midiOut.send( [0x80, 3, 32] );
        // light up the stop button
        midiOut.send( [0x90, 7, 1] );
    }
}

function handleStop(event) {
    timerWorker.postMessage("stop");

    var elOld = document.getElementById('LED_' + (rhythmIndex + 14) % 16);
    elOld.src = 'images/LED_off.png';

    hideBeat( (rhythmIndex + 14) % 16 );

    rhythmIndex = 0;

    document.getElementById('play').classList.remove('playing');
    document.getElementById('stop').classList.remove('playing');
    if (midiOut) {
        // light up the play button
        midiOut.send( [0x90, 3, 32] );
        // turn off the stop button
        midiOut.send( [0x80, 7, 1] );
    }
}

function handleLoadOk(event) {
    var elTextarea = document.getElementById('load_textarea');
    theBeat = JSON.parse(elTextarea.value);

    // Set drumkit
    currentKit = kits[theBeat.kitIndex];
    document.getElementById('kitname').innerHTML = kitNamePretty[theBeat.kitIndex];

    // Set effect
    setEffect(theBeat.effectIndex);

    // Change the volume of the convolution effect.
    setEffectLevel(theBeat);

    // Apply values from sliders
    sliderSetValue('effect_thumb', theBeat.effectMix);
    sliderSetValue('kick_thumb', theBeat.kickPitchVal);
    sliderSetValue('snare_thumb', theBeat.snarePitchVal);
    sliderSetValue('hihat_thumb', theBeat.hihatPitchVal);
    sliderSetValue('tom1_thumb', theBeat.tom1PitchVal);
    sliderSetValue('tom2_thumb', theBeat.tom2PitchVal);
    sliderSetValue('tom3_thumb', theBeat.tom3PitchVal);
    sliderSetValue('swing_thumb', theBeat.swingFactor);

    // Clear out the text area post-processing
    elTextarea.value = '';

    toggleLoadContainer();
    updateControls();
}

function handleLoadCancel(event) {
    toggleLoadContainer();
}

function toggleSaveContainer() {
    document.getElementById('pad').classList.toggle('active');
    document.getElementById('params').classList.toggle('active');
    document.getElementById('tools').classList.toggle('active');
    document.getElementById('save_container').classList.toggle('active');
}

function toggleLoadContainer() {
    document.getElementById('pad').classList.toggle('active');
    document.getElementById('params').classList.toggle('active');
    document.getElementById('tools').classList.toggle('active');
    document.getElementById('load_container').classList.toggle('active');
}

function handleReset(event) {
    handleStop();
    loadBeat(beatReset);
}

function loadBeat(beat) {
    // Check that assets are loaded.
    if (beat != beatReset && !beat.isLoaded())
        return false;

    handleStop();

    theBeat = cloneBeat(beat);
    currentKit = kits[theBeat.kitIndex];
    setEffect(theBeat.effectIndex);

    // apply values from sliders
    sliderSetValue('effect_thumb', theBeat.effectMix);
    sliderSetValue('kick_thumb', theBeat.kickPitchVal);
    sliderSetValue('snare_thumb', theBeat.snarePitchVal);
    sliderSetValue('hihat_thumb', theBeat.hihatPitchVal);
    sliderSetValue('tom1_thumb', theBeat.tom1PitchVal);
    sliderSetValue('tom2_thumb', theBeat.tom2PitchVal);
    sliderSetValue('tom3_thumb', theBeat.tom3PitchVal);
    sliderSetValue('swing_thumb', theBeat.swingFactor);

    updateControls();
    setActiveInstrument(0);

    return true;
}

function updateControls() {
    for (i = 0; i < loopLength; ++i) {
        for (j = 0; j < kNumInstruments; j++) {
            switch (j) {
                case 0: notes = theBeat.rhythm1; break;
                case 1: notes = theBeat.rhythm2; break;
                case 2: notes = theBeat.rhythm3; break;
                case 3: notes = theBeat.rhythm4; break;
                case 4: notes = theBeat.rhythm5; break;
                case 5: notes = theBeat.rhythm6; break;
            }

            drawNote(notes[i], i, j);
        }
    }
    /*
    document.getElementById('kitname').innerHTML = kitNamePretty[theBeat.kitIndex];
    document.getElementById('effectname').innerHTML = impulseResponseInfoList[theBeat.effectIndex].name;
    document.getElementById('tempo').innerHTML = theBeat.tempo;
    sliderSetPosition('swing_thumb', theBeat.swingFactor);
    sliderSetPosition('effect_thumb', theBeat.effectMix);
    sliderSetPosition('kick_thumb', theBeat.kickPitchVal);
    sliderSetPosition('snare_thumb', theBeat.snarePitchVal);
    sliderSetPosition('hihat_thumb', theBeat.hihatPitchVal);
    sliderSetPosition('tom1_thumb', theBeat.tom1PitchVal);
    sliderSetPosition('tom2_thumb', theBeat.tom2PitchVal);
    sliderSetPosition('tom3_thumb', theBeat.tom3PitchVal);
    */
}


function drawNote(draw, xindex, yindex) {
/*
    var elButton = document.getElementById(instruments[yindex] + '_' + xindex);
    switch (draw) {
        case 0: elButton.src = 'images/button_off.png'; break;
        case 1: elButton.src = 'images/button_half.png'; break;
        case 2: elButton.src = 'images/button_on.png'; break;
    }
*/
}

function drawPlayhead(xindex) {
    var lastIndex = (xindex + 15) % 16;

    var elNew = document.getElementById('LED_' + xindex);
    var elOld = document.getElementById('LED_' + lastIndex);

    elNew.src = 'images/LED_on.png';
    elOld.src = 'images/LED_off.png';

    hideBeat( lastIndex );
    showBeat( xindex );
}

function filterFrequencyFromCutoff( cutoff ) {
    var nyquist = 0.5 * context.sampleRate;

    // spreads over a ~ten-octave range, from 20Hz - 20kHz.
    var filterFrequency = Math.pow(2, (11 * cutoff)) * 40;

    if (filterFrequency > nyquist)
        filterFrequency = nyquist;
    return filterFrequency;
}

function setFilterCutoff( cutoff ) {
    if (filterNode)
        filterNode.frequency.value = filterFrequencyFromCutoff( cutoff );
}

function setFilterQ( Q ) {
    if (filterNode)
        filterNode.Q.value = Q;
}
</script>
</body>
</html>
